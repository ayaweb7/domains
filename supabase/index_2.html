<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Магазинчик SB</title>
    <!-- Подключаем стили для красивого отображения таблицы -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <!-- Небольшие свои стили -->
    <style>
        body {
            font-family: sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #purchases-table {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>История моих покупочек</h1>

    <!-- Контейнер для таблицы -->
    <div id="purchases-table"></div>
    <div id="loading" class="loading">Загрузка данных...</div>

    <!-- Подключаем библиотеки -->
    <!-- Supabase клиентская библиотека -->
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <!-- Библиотека Tabulator для создания продвинутых таблиц -->
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>

    <script>
        // ИНИЦИАЛИЗАЦИЯ SUPABASE
        // ВАЖНО: ЗАМЕНИТЕ ЭТИ ЗНАЧЕНИЯ НА СВОИ!
        const supabaseUrl = 'https://fmlozfzmonszroxsrldk.supabase.co';// Ваш Supabase URL
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtbG96Znptb25zenJveHNybGRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTgxMTAsImV4cCI6MjA3MTg5NDExMH0.WQRiC0vg1tVF2vTlO7uMst6FYZnWW_76NMYKwPoL4iw';// Ваш anon key из настроек API
        // Создаем клиент Supabase
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        // ЭЛЕМЕНТЫ ДОМ
        const tableElement = document.getElementById('purchases-table');
        const loadingElement = document.getElementById('loading');

		// ОСНОВНАЯ ФУНКЦИЯ ДЛЯ ЗАГРУЗКИ И ОТОБРАЖЕНИЯ ДАННЫХ
		async function loadPurchasesData() {
			try {
				console.log("Начинаем загрузку данных...");
				const allRows = []; // Сюда соберем ВСЕ данные
				const pageSize = 1000; // Максимальный размер страницы по API
				let from = 0; // Начинаем с первой записи
				let hasMoreData = true;

				// Цикл для последовательной загрузки данных страницами
				while (hasMoreData) {
					const { data: pageData, error, count } = await supabase
						.from('shops')
						.select('*', { count: 'exact' }) // Запрашиваем общее количество строк
						.order('id', { ascending: true }) // Важно: сортируем по ID
						.range(from, from + pageSize - 1); // Запрашиваем конкретную "страницу"

					if (error) {
						console.error('Ошибка при загрузке страницы:', error);
						throw error;
					}

					if (pageData && pageData.length > 0) {
						allRows.push(...pageData); // Добавляем данные страницы в общий массив
						from += pageSize; // Переходим к следующей странице
						console.log(`Загружено страниц: ${allRows.length / pageSize}, записей: ${allRows.length}`);
					} else {
						hasMoreData = false; // Данные закончились
					}

					// Защита от бесконечного цикла
					if (from > 10000) {
						console.warn('Прервано по защите от бесконечного цикла');
						hasMoreData = false;
					}
				}

				console.log('Всего загружено записей:', allRows.length);
				loadingElement.style.display = 'none';

				// 4. Инициализируем Tabulator со ВСЕМИ данными
				new Tabulator(tableElement, {
					data: allRows, // Передаем ВЕСЬ массив данных
					layout: "fitColumns",
					pagination: "local",
					paginationSize: 20,
					paginationSizeSelector: [10, 20, 50, 100, 500],
					movableColumns: true,
					maxHeight: "100%",
					columns: [
						// ID: Просто показываем номер
						{
							title: "ID",
							field: "id", // Просто отображаем значение поля 'id'
							hozAlign: "left",
							headerFilter: "input"
						},
						// ДАТА: 
						{
							title: "Дата",
							field: "date",
							hozAlign: "left",
							headerFilter: "input",
							sorter: "date",
							sorterParams: { format: "yyyy-MM-dd" },
							formatter: function(cell, formatterParams, onRendered) {
								const dateObj = new Date(cell.getValue() + 'T00:00:00');
								return dateObj.toLocaleDateString('ru-RU');
							}
						},
						// ТОВАР
						{ 
							title: "Товар",
							field: "name",
							headerFilter: "input"
						},
						// МАГАЗИН
						{
							title: "Магазин",
							field: "shop",
							headerFilter: "input"
						},
						// ЦЕНА
						{ 
							title: "Цена",
							field: "price",
							hozAlign: "right"
						}
					],
				});

			} catch (error) {
				console.error('Ошибка:', error);
				loadingElement.textContent = 'Ошибка при загрузки данных.';
			}
		}

        // Запускаем всю логику после загрузки страницы
        document.addEventListener('DOMContentLoaded', loadPurchasesData);
    </script>
</body>
</html>